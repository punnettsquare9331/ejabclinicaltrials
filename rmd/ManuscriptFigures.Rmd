---
title: "Manuscript Figures"
output: html_document
date: "2025-04-13"
---
```{r}
source("../rfuncs/EJABPVALUEPLOT.R", local = knitr::knit_global())
source("../rfuncs/DirichletMultinomial.R", local = knitr::knit_global())
```

```{r}
library(dplyr)
library(tidyr)
library(cowplot)
library(ggridges)
library(ggplot2)
library(qvalue)
```

```{r, include=FALSE}
source("../CTGJAB.R", local = knitr::knit_global())
alpha_0.05_results <- posterior_analysis(study3_summary, 5000, 0.05)
```

```{r}
study3_summary2 <- study3_summary %>%
  mutate(
    Significant05 = if_else(pValue <= 0.05, "Significant", "Non-significant"),
    Significant005 = if_else(pValue <= 0.005, "Significant", "Non-significant"),
    BF = case_when(
      JAB < 0.3 ~ "<1/3 (H1)",
      JAB >= 0.3 & JAB <= 3 ~ "[1/3, 3] (I)",
      JAB > 3 ~ ">3 (H0)"
    ),
    BF = factor(BF, levels = c("<1/3 (H1)", "[1/3, 3] (I)", ">3 (H0)"))
  )
```

# Figure 3a

```{r}
filtered_df <- study3_summary

# Step 2: Define fine alpha grid
alphas_fine <- seq(0.001, 1, length.out = 1000)

# Step 3: Compute proportions over fine grid

proportions <- sapply(alphas_fine, function(a) {
  mean(filtered_df$JAB > 1 & filtered_df$pValue <= a)
})

n <- nrow(filtered_df)

# Then, compute the confidence interval (lower bound)
low <- proportions - 1.96 * sqrt((proportions * (1 - proportions)) / n)

high <- proportions + 1.96 * sqrt((proportions * (1 - proportions)) / n)


# Create the data frame
proportion_data <- data.frame(
  alpha = alphas_fine,
  proportion = proportions,
  n = n,
  low = low,
  high = high
)

# Step 4: Downsample for main plot (100 points evenly spaced)
alphas_main <- seq(0.01, 1, length.out = 100)
plot_main_data <- proportion_data %>% filter(alpha %in% alphas_main)

# Step 5: Create main plot
main_plot <- ggplot(plot_main_data, aes(x = alpha, y = proportion)) +
  geom_line(color = "green", size = 1) +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted", color = "black") +
  geom_abline(intercept = mean(filtered_df$JAB > 1), slope = 0, linetype = "dotted", color = "red") +
  labs(
    title = "Proportion of Analyses with eJAB01 > 1 and p \u2264 \u03B1",
    x = expression(alpha),
    y = "Observed Proportion"
  ) +
  geom_ribbon(aes(ymin = low, ymax = high), alpha = 0.2) +
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 12),
    plot.title = element_text(size = 20)  # Increase the title size here
  )

# Step 6: Create inset plot for alpha ≤ 0.25 using fine resolution
inset_plot <- ggplot(proportion_data %>% filter(alpha <= 0.4), aes(x = alpha, y = proportion)) +
  geom_line(color = "green", size = 0.8) +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted", color = "black") +
  labs(x = NULL, y = NULL) +
  geom_ribbon(aes(ymin = low, ymax = high), alpha = 0.2) +
  theme_minimal(base_size = 12) +
  theme(
    axis.title.y = element_blank(),
    axis.text = element_text(size = 12),
    plot.background = element_rect(fill = "white", color = "black")
  )

# Step 7: Combine with inset
alpha_plot <- ggdraw() +
  draw_plot(main_plot) +
  draw_plot(inset_plot, x = 0.6, y = 0.15, width = 0.35, height = 0.35)

# Step 8: Display
print(alpha_plot)
```

# Figure 3b

```{r}
# Step 1: Filter out NAs and pValues exactly equal to 0.05
filtered_df <- study3_summary %>% filter(has_less_than == FALSE, pValue != 0.05)

# Step 2: Define fine alpha grid
alphas_fine <- seq(0.001, 1, length.out = 1000)

# Step 3: Compute proportions over fine grid

proportions <- sapply(alphas_fine, function(a) {
  mean(filtered_df$JAB > 1 & filtered_df$pValue <= a)
})

n <- nrow(filtered_df)

# Then, compute the confidence interval (lower bound)
low <- proportions - 1.96 * sqrt((proportions * (1 - proportions)) / n)

high <- proportions + 1.96 * sqrt((proportions * (1 - proportions)) / n)


# Create the data frame
proportion_data <- data.frame(
  alpha = alphas_fine,
  proportion = proportions,
  n = n,
  low = low,
  high = high
)

# Step 4: Downsample for main plot (100 points evenly spaced)
alphas_main <- seq(0.01, 1, length.out = 100)
plot_main_data <- proportion_data %>% filter(alpha %in% alphas_main)

# Step 5: Create main plot
main_plot <- ggplot(plot_main_data, aes(x = alpha, y = proportion)) +
  geom_line(color = "green", size = 1) +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted", color = "black") +
  geom_abline(intercept = mean(filtered_df$JAB > 1), slope = 0, linetype = "dotted", color = "red") +
  labs(
    title = "Proportion of Analyses with eJAB01 > 1 and p \u2264 \u03B1",
    x = expression(alpha),
    y = "Observed Proportion"
  ) +
  geom_ribbon(aes(ymin = low, ymax = high), alpha = 0.2) +
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 12),
    plot.title = element_text(size = 20)  # Increase the title size here
  )

# Step 6: Create inset plot for alpha ≤ 0.25 using fine resolution
inset_plot <- ggplot(proportion_data %>% filter(alpha <= 0.4), aes(x = alpha, y = proportion)) +
  geom_line(color = "green", size = 0.8) +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted", color = "black") +
  labs(x = NULL, y = NULL) +
  geom_ribbon(aes(ymin = low, ymax = high), alpha = 0.2) +
  theme_minimal(base_size = 12) +
  theme(
    axis.title.y = element_blank(),
    axis.text = element_text(size = 12),
    plot.background = element_rect(fill = "white", color = "black")
  )

# Step 7: Combine with inset
alpha_plot <- ggdraw() +
  draw_plot(main_plot) +
  draw_plot(inset_plot, x = 0.6, y = 0.15, width = 0.35, height = 0.35)

# Step 8: Display
print(alpha_plot)

```
# Figure 3c 
```{r}
# Create a density plot using kernel density estimation
# Calculate mean once to avoid repetition
mean_val <- mean(alpha_0.05_results$data, na.rm = TRUE)
sd_val <- sd(alpha_0.05_results$data, na.rm = TRUE)

# Create density plot
density_plot <- ggplot(data.frame(value = alpha_0.05_results$data), aes(x = value)) +
  geom_density(fill = "blue", alpha = 0.5) +  # Gaussian kernel is default
  geom_vline(xintercept = mean_val, color = "red", linetype = "dashed", size = 1) +

  labs(
    x = "Proportion",
    y = "Density",
    title = "Prop. of all p \u2264 0.05 Analyses with eJAB01 > 1/3"
  ) +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 12),
    plot.title = element_text(size = 20)  # Increase the title size here
  )
density_plot
```


# Figure 3d

```{r}
analysis_plot = plot_data_summary(study3_summary)
analysis_plot
```



#Figure 3e

```{r}
# Density plot for the Significant group
nice_Ns <- c(20, 200, 2000, 20000, 200000)
p_sig <- study3_summary2 %>%
  filter(Significant05 == "Significant", !is.na(BF)) %>%
  ggplot(aes(x = log(N), fill = BF)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(
    breaks = log(nice_Ns),
    labels = nice_Ns,
    name = "Sample Size"
  ) +
  labs(title = "p \u2264 0.05 Analyses: Density of Sample Sizes by BF",
       x = "Sample Size log(N)",
       y = "Density") +
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 12),
    plot.title = element_text(size = 20)  # Increase the title size here
  )

# Density plot for the Non-significant group
p_non_sig <- study3_summary2 %>%
  filter(Significant05 == "Non-significant", !is.na(BF)) %>%
  ggplot(aes(x = log(N), fill = BF)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(
    breaks = log(nice_Ns),
    labels = nice_Ns,
    name = "Sample Size"
  ) +
  labs(title = "Non-significant (p \u2265 0.05): Density of Sample Sizes by Bayes factor Category",
       x = "Sample Size log(N)",
       y = "Density") +
  theme_minimal()

# Display the plots separately
print(p_sig)
print(p_non_sig)
```
```{r}
# Step 1: Use full dataset (don't filter yet)
n_all <- nrow(study3_summary)

# Step 2: Extended canonical BF breaks
bf_breaks <- c(1/300, 1/100, 1/30, 1/10, 1/3, 1, 3, 10, 30, 100, 300)

# Step 3: Define fine grid (log scale)
bf_fine <- exp(seq(log(min(bf_breaks)), log(max(bf_breaks)), length.out = 1000))

# Step 4: Compute proportions (both conditions jointly)
proportions <- sapply(bf_fine, function(b) {
  mean(study3_summary$pValue <= 0.05 & study3_summary$JAB >= b)
})

# Step 5: Binomial confidence intervals
low <- proportions - 1.96 * sqrt((proportions * (1 - proportions)) / n_all)
high <- proportions + 1.96 * sqrt((proportions * (1 - proportions)) / n_all)

# Step 6: Create dataframe
proportion_data <- data.frame(
  bf = bf_fine,
  proportion = proportions,
  low = pmax(low, 0),
  high = pmin(high, 1)
)

# Step 7: Main plot on log scale with more breaks
main_plot <- ggplot(proportion_data, aes(x = bf, y = proportion)) +
  geom_line(color = "blue", size = 1) +
  labs(
    title = "Prop. of Analyses with p ≤ 0.05 and eJAB01 ≥ θ",
    x = "θ",
    y = "Observed Proportion"
  ) +
  geom_ribbon(aes(ymin = low, ymax = high), alpha = 0.2) +
  scale_x_log10(
    breaks = bf_breaks,
    labels = scales::label_number(accuracy = 0.01, trim = TRUE)
  ) +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 12),
    plot.title = element_text(size = 20)
  )

# Step 9: Inset plot for right tail (BF ≥ 30)
inset_plot <- ggplot(proportion_data %>% filter(bf >= 3), aes(x = bf, y = proportion)) +
  geom_line(color = "blue", size = 0.8) +
  geom_ribbon(aes(ymin = low, ymax = high), alpha = 0.2) +
  scale_x_log10(
    breaks = bf_breaks[bf_breaks >= 3],
    labels = scales::label_number(accuracy = 0.01, trim = TRUE)
  ) +
  labs(x = NULL, y = NULL) +
  theme_minimal(base_size = 12) +
  theme(
    axis.title = element_blank(),
    axis.text = element_text(size = 10),
    plot.background = element_rect(fill = "white", color = "black")
  )

# Step 10: Combine with main plot
final_plot <- ggdraw() +
  draw_plot(main_plot) +
  draw_plot(inset_plot, x = 0.5, y = 0.5, width = 0.5, height = 0.4)

print(final_plot)

```

#Figure 4a

```{r}
# Reshape data for plotting
df_long2 <- study3_summary2 %>%
  # Filter for outcome type if needed
  filter(outcomeType == "PRIMARY") %>%
  # Convert phase columns to long format
  pivot_longer(
    cols = c(EARLY_PHASE1, PHASE1, PHASE2, PHASE3, PHASE4),
    names_to = "Phase",
    values_to = "Indicator"
  ) %>%
  filter(Indicator == 1) %>%
  # Clean phase names
  mutate(
    Phase = case_when(
      Phase == "EARLY_PHASE1" ~ "Early Phase 1",
      Phase == "PHASE1" ~ "Phase 1",
      Phase == "PHASE2" ~ "Phase 2",
      Phase == "PHASE3" ~ "Phase 3",
      Phase == "PHASE4" ~ "Phase 4"
    ),
    # Log transformations
    logP = log(pValue),
    logJAB = log(JAB)
  ) %>%
  # Transform to long format for plotting
  pivot_longer(
    cols = c(logJAB, logP),
    names_to = "Metric",
    values_to = "Value"
  )

# Calculate average sample size by phase
avg_sample_size <- df_long2 %>%
  group_by(Phase) %>%
  summarize(avg_N = mean(N, na.rm = TRUE)) %>%
  mutate(label = paste0("avg. n = ", round(avg_N, 0)))

# Create plot
ggplot(df_long2, aes(x = Phase, y = Value, fill = Metric)) +
  geom_boxplot() +
  # Reference lines
  geom_hline(yintercept = log(1/3), linetype = "dashed") +
  geom_hline(yintercept = log(3), linetype = "dashed") +
  geom_hline(yintercept = log(0.05), linetype = "dashed", color = "red") +
  # Add sample size labels
  geom_text(
    data = avg_sample_size,
    aes(x = Phase, y = 6, label = label),
    inherit.aes = FALSE,
    size = 3
  ) +
  # Labels and formatting
  labs(title = "ln(eJAB01) and ln(pValue) by Phase, Primary Outcomes",
       x = "Phase", y = "Value") +
  scale_fill_manual(
    values = c("logJAB" = "#1f77b4", "logP" = "#ff7f0e"),
    labels = c("ln(eJAB01)", "ln(pValue)")
  ) +
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 10),
    plot.title = element_text(size = 10)  # Increase the title size here
  )
```

#Figure 4b

```{r}
# Reshape data for plotting
df_long3 <- study3_summary2 %>%
  # Filter for outcome type if needed
  filter(outcomeType == "SECONDARY") %>%
  # Convert phase columns to long format
  pivot_longer(
    cols = c(EARLY_PHASE1, PHASE1, PHASE2, PHASE3, PHASE4),
    names_to = "Phase",
    values_to = "Indicator"
  ) %>%
  filter(Indicator == 1) %>%
  # Clean phase names
  mutate(
    Phase = case_when(
      Phase == "EARLY_PHASE1" ~ "Early Phase 1",
      Phase == "PHASE1" ~ "Phase 1",
      Phase == "PHASE2" ~ "Phase 2",
      Phase == "PHASE3" ~ "Phase 3",
      Phase == "PHASE4" ~ "Phase 4"
    ),
    # Log transformations
    logP = log(pValue),
    logJAB = log(JAB)
  ) %>%
  # Transform to long format for plotting
  pivot_longer(
    cols = c(logJAB, logP),
    names_to = "Metric",
    values_to = "Value"
  )

# Calculate average sample size by phase
avg_sample_size <- df_long3 %>%
  group_by(Phase) %>%
  summarize(avg_N = mean(N, na.rm = TRUE)) %>%
  mutate(label = paste0("avg. n = ", round(avg_N, 0)))

# Create plot
ggplot(df_long3, aes(x = Phase, y = Value, fill = Metric)) +
  geom_boxplot() +
  # Reference lines
  geom_hline(yintercept = log(1/3), linetype = "dashed") +
  geom_hline(yintercept = log(3), linetype = "dashed") +
  geom_hline(yintercept = log(0.05), linetype = "dashed", color = "red") +
  # Add sample size labels
  geom_text(
    data = avg_sample_size,
    aes(x = Phase, y = 6, label = label),
    inherit.aes = FALSE,
    size = 3
  ) +
  # Labels and formatting
  labs(title = "ln(eJAB01) and ln(pValue) by Phase, Secondary Outcomes",
       x = "Phase", y = "Value") +
  scale_fill_manual(
    values = c("logJAB" = "#1f77b4", "logP" = "#ff7f0e"),
    labels = c("ln(eJAB01)", "ln(pValue)")
  ) +
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 10),
    plot.title = element_text(size = 10)  # Increase the title size here
  )
```


#4c and 4d

```{r}
library(lme4)
library(rlang)

study_col <- "nctId"
test_col  <- "analysisId"

# Prepare data (all outcomes)
df_long2 <- study3_summary2 %>%
  pivot_longer(
    cols = c(EARLY_PHASE1, PHASE1, PHASE2, PHASE3, PHASE4),
    names_to = "Phase",
    values_to = "Indicator"
  ) %>%
  filter(Indicator == 1) %>%
  mutate(
    Phase = case_when(
      Phase == "EARLY_PHASE1" ~ "Early Phase 1",
      Phase == "PHASE1" ~ "Phase 1",
      Phase == "PHASE2" ~ "Phase 2",
      Phase == "PHASE3" ~ "Phase 3",
      Phase == "PHASE4" ~ "Phase 4"
    ),
    Phase = factor(Phase, levels = c("Early Phase 1","Phase 1","Phase 2","Phase 3","Phase 4"))
  ) %>%
  filter(!is.na(JAB), !is.na(pValue), JAB > 0, pValue > 0) %>%
  mutate(
    logP = log(pValue),
    logJAB = log(JAB),
    Study = !!sym(study_col),
    Test  = !!sym(test_col)
  ) %>%
  pivot_longer(
    cols = c(logJAB, logP),
    names_to = "Metric",
    values_to = "Value"
  )

# Avg sample size labels
avg_sample_size <- df_long2 %>%
  group_by(outcomeType, Phase) %>%
  summarize(avg_N = mean(N, na.rm = TRUE), .groups = "drop") %>%
  mutate(label = paste0("avg. n = ", round(avg_N, 0)))

# Fit RE per outcomeType + Metric, add residuals and mu-hat, then compute Adjusted = mu_hat + residual
fit_add_adjusted <- function(df) {
    df <- df %>% filter(!is.na(Study), !is.na(Value))
    m <- lmer(Value ~ 1 + (1 | Study), data = df, REML = TRUE)
    mu_hat <- fixef(m)[["(Intercept)"]]
    df$Residual <- resid(m)
    df$mu_hat  <- mu_hat
    df$Adjusted <- df$Residual + df$mu_hat
    return(df)

}

df_adj_long <- df_long2 %>%
  group_by(Metric) %>%
  group_modify(~ fit_add_adjusted(.x)) %>%
  ungroup() %>%
  mutate(Metric = recode(Metric,
                         logJAB = "Adjusted ln(eJAB01)",
                         logP   = "Adjusted ln(pValue)"))

make_plot_for_outcome <- function(outcome, outcome_label) {
  d <- df_adj_long %>% filter(outcomeType == outcome)
  lab <- avg_sample_size %>% filter(outcomeType == outcome)
  y_top <- max(d$Adjusted, na.rm = TRUE)
  ggplot(d, aes(x = Phase, y = Adjusted, fill = Metric)) +
    geom_boxplot() +
    # Keep original reference lines
    geom_hline(yintercept = log(1/3), linetype = "dashed") +
    geom_hline(yintercept = log(3),   linetype = "dashed") +
    geom_hline(yintercept = log(0.05), linetype = "dashed", color = "red") +
    geom_text(
      data = lab,
      aes(x = Phase, y = y_top * 1.2, label = label),
      inherit.aes = FALSE,
      size = 3
    ) +
    labs(
      title = paste0("Adjusted ln(eJAB) and ln(pValue) by Phase, ", outcome_label, ""),
      x = "Phase",
      y = "Value"
    ) +
    scale_fill_manual(
      values = c("Adjusted ln(eJAB01)" = "#1f77b4",
                 "Adjusted ln(pValue)" = "#ff7f0e")
    ) +
    theme_minimal() +
    theme(
      axis.title = element_text(size = 20),
      axis.text = element_text(size = 10),
      plot.title = element_text(size = 10)
    )
}

plot_primary   <- make_plot_for_outcome("PRIMARY", "Primary Outcomes")
plot_secondary <- make_plot_for_outcome("SECONDARY", "Secondary Outcomes")

print(plot_primary)
print(plot_secondary)

```
#Candidate Type 1 Errors

```{r}
CTE01 = study3_summary %>% filter(JAB > 1, pValue <= 0.01)
write.csv(candidateType101, "../csv/CTE01.csv")
```

```{r}
CTE05 = study3_summary %>% filter(JAB > 1, pValue <= 0.05)
write.csv(CTE05, "../csv/CTE05.csv")
```

#JLP
```{r}
JLP05 = study3_summary %>% filter(JAB > 3, pValue <= 0.05)
write.csv(CTE05, "../csv/JLP05.csv")
```

```{r}
df_adj_long2 <- df_adj_long %>% mutate(Fitted = Value - Residual)

# Optional: cleaner facet labels
metric_labs <- c(
  "Adjusted ln(eJAB01)" = "ln(eJAB)",
  "Adjusted ln(pValue)" = "ln(pValue)"
)

p <- df_adj_long2 %>%
  filter(!is.na(Fitted), !is.na(Residual)) %>%
  ggplot(aes(x = Fitted, y = Residual, color = Phase)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
  geom_point(alpha = 0.5, size = 1.4) +
  geom_smooth(method = "loess", se = FALSE, color = "black") +
  facet_wrap(~ Metric, labeller = labeller(Metric = metric_labs), scales = "free") +
  labs(
    title = "Residuals vs Fitted Values",
    x = "Fitted Values",
    y = "Residuals",
    color = "Phase"
  ) +
  theme_minimal()

print(p)
```

